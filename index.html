<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <!-- Main navigation - always visible -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm" style="z-index: 1000;">
        <div class="container px-4">
            <a class="navbar-brand text-primary font-weight-bold" href="#" onclick="event.preventDefault(); showLanding();">iLearn</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item" id="authButtons">
                        <button class="btn btn-primary ml-2" onclick="showAuthModal()">Sign In</button>
                        <button class="btn btn-outline-primary ml-2" onclick="showAuthModal(true)">Create Account</button>
                    </li>
                    <li class="nav-item" id="userButtons" style="display: none;">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-user"></i> <span id="userName">Account</span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="#" id="dashboardLink">Dashboard</a>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" type="button" id="signOutButton">Sign Out</button>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main content container -->
    <div id="mainContent">
        <div id="landingContent" class="page-content" style="display: none;">
            <section class="bg-primary text-white py-5 mt-5">
                <div class="container px-4">
                    <div class="row align-items-center">
                        <div class="col-lg-6 mb-4 mb-lg-0">
                            <h1 class="display-4 font-weight-bold mb-3">iLearn</h1>
                            <p class="lead mb-4">A modern solution for university learning. Manage assignments, create teams, and collaborate effectively.</p>
                            <div class="d-flex flex-column flex-sm-row">
                                <a href="#" class="btn btn-light btn-lg mb-2 mb-sm-0 mr-sm-3" onclick="showAuthModal(true)">Get Started</a>
                                <a href="#" class="btn btn-outline-light btn-lg" onclick="event.preventDefault(); scrollToSection('about');">Learn More</a>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <img src="https://static.vecteezy.com/system/resources/thumbnails/019/586/169/small_2x/online-documentation-database-and-process-document-electronic-automation-platform-it-staff-working-with-document-management-system-dms-corporate-business-technology-cognition-on-modern-management-photo.jpg" alt="Hero Image" class="img-fluid rounded shadow">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add Key Benefits Section -->
            <section class="py-5 bg-light">
                <div class="container px-4">
                    <h2 class="text-center mb-5">Why Choose iLearn?</h2>
                    <div class="row text-center">
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="icon-circle bg-primary text-white mx-auto mb-3">
                                        <i class="fas fa-users fa-2x"></i>
                                    </div>
                                    <h4 class="card-title">Enhanced Collaboration</h4>
                                    <p class="card-text">Easily form teams, manage group projects, and provide structured peer feedback.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="icon-circle bg-success text-white mx-auto mb-3">
                                        <i class="fas fa-tasks fa-2x"></i>
                                    </div>
                                    <h4 class="card-title">Streamlined Workflow</h4>
                                    <p class="card-text">Centralize assignments, reviews, and communication for students and instructors.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                           <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="icon-circle bg-info text-white mx-auto mb-3">
                                         <i class="fas fa-chart-line fa-2x"></i>
                                    </div>
                                    <h4 class="card-title">Actionable Insights</h4>
                                    <p class="card-text">Generate reports on team performance and individual contributions.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- End Key Benefits Section -->

            <!-- Add About Section -->
            <section id="about" class="py-5">
                <div class="container px-4">
                    <h2 class="text-center mb-4">Learn More About iLearn</h2>
                    <div class="row">
                        <div class="col-md-8 mx-auto text-center">
                            <p class="lead">iLearn provides a comprehensive platform for managing university coursework, facilitating collaboration among students and instructors. Track assignments, form teams, conduct peer reviews, and gain insights into performance, all in one place.</p>
                            <p>Our goal is to streamline the learning process and enhance educational outcomes through technology.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Add Features Section -->
            <section id="features" class="py-5 bg-light">
                 <div class="container px-4">
                      <h2 class="text-center mb-5">Core Features</h2>
                      <div class="row">
                          <div class="col-md-6 col-lg-3 mb-4 text-center">
                              <div class="mb-3"><i class="fas fa-users-cog fa-3x text-primary"></i></div>
                              <h5>Team Management</h5>
                              <p class="text-muted">Instructors can easily create and manage student teams for projects and assignments.</p>
                          </div>
                          <div class="col-md-6 col-lg-3 mb-4 text-center">
                              <div class="mb-3"><i class="fas fa-comments fa-3x text-success"></i></div>
                              <h5>Peer Review System</h5>
                              <p class="text-muted">Facilitate constructive feedback with customizable peer review templates and workflows.</p>
                          </div>
                          <div class="col-md-6 col-lg-3 mb-4 text-center">
                              <div class="mb-3"><i class="fas fa-file-alt fa-3x text-info"></i></div>
                              <h5>Assignment Tracking</h5>
                              <p class="text-muted">Students and instructors can track assignment submissions and review status.</p>
                          </div>
                          <div class="col-md-6 col-lg-3 mb-4 text-center">
                              <div class="mb-3"><i class="fas fa-chart-pie fa-3x text-warning"></i></div>
                              <h5>Performance Reports</h5>
                              <p class="text-muted">Generate insightful reports on team dynamics and individual contributions based on reviews.</p>
                          </div>
                      </div>
                 </div>
            </section>

             <!-- Add Contact Section -->
            <section id="contact" class="py-5">
                 <div class="container px-4">
                      <h2 class="text-center mb-4">Contact Us</h2>
                       <div class="row">
                           <div class="col-md-8 mx-auto">
                               <p class="text-center mb-4">Have questions or feedback? Fill out the form below and we'll get back to you.</p>
                               <form id="contactForm">
                                   <div class="form-row">
                                       <div class="form-group col-md-6">
                                           <label for="contactName">Name</label>
                                           <input type="text" class="form-control" id="contactName" placeholder="Your Name" required>
                                       </div>
                                       <div class="form-group col-md-6">
                                           <label for="contactEmail">Email</label>
                                           <input type="email" class="form-control" id="contactEmail" placeholder="Your Email" required>
                                       </div>
                                   </div>
                                   <div class="form-group">
                                       <label for="contactSubject">Subject</label>
                                       <input type="text" class="form-control" id="contactSubject" placeholder="Subject">
                                   </div>
                                   <div class="form-group">
                                       <label for="contactMessage">Message</label>
                                       <textarea class="form-control" id="contactMessage" rows="5" placeholder="Your Message" required></textarea>
                                   </div>
                                   <div class="text-center">
                                       <button type="submit" class="btn btn-primary btn-lg">Send Message</button>
                                   </div>
                               </form>
                           </div>
                       </div>
                 </div>
            </section>

        </div>

        <!-- Dashboard Pages -->
        <div id="studentDashboardContent" class="page-content" style="display: none;">
            <!-- Student Dashboard -->
            <div id="studentDashboardPageContent">
                <div class="container py-4" style="padding-top: 5rem;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn-secondary" onclick="showLanding()">&larr; Back to Landing Page</button>
                        <h1 class="mb-0">Student Dashboard</h1>
                    </div>
                    <ul class="nav nav-tabs" id="studentTabs" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="student-overview-tab" data-toggle="tab" href="#student-overview" role="tab">Overview</a></li>
                        <li class="nav-item"><a class="nav-link" id="student-courses-tab" data-toggle="tab" href="#student-courses" role="tab">Courses</a></li>
                        <li class="nav-item"><a class="nav-link" id="student-teams-tab" data-toggle="tab" href="#student-teams" role="tab">Teams</a></li>
                        <li class="nav-item"><a class="nav-link" id="student-reviews-tab" data-toggle="tab" href="#student-reviews" role="tab">Reviews</a></li>
                        <li class="nav-item"><a class="nav-link" id="student-reports-tab" data-toggle="tab" href="#student-reports" role="tab">Reports</a></li>
                    </ul>
                    <div class="tab-content pt-3">
                        <!-- Student Overview Tab -->
                        <div class="tab-pane fade show active" id="student-overview" role="tabpanel">
                            <h3>Welcome, <span id="studentUserName">Student</span>!</h3>
                            <p>This is your student dashboard. Use the tabs to manage your courses, teams, and reviews.</p>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">Courses Enrolled <span class="badge badge-primary badge-pill">2</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Teams <span class="badge badge-success badge-pill">1</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Pending Reviews <span class="badge badge-warning badge-pill">1</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Completed Reviews <span class="badge badge-info badge-pill">3</span></li>
                            </ul>
                        </div>
                        <!-- Student Courses Tab -->
                        <div class="tab-pane fade" id="student-courses" role="tabpanel">
                            <h3>My Courses</h3>
                            <div class="input-group mb-3">
                                <input type="text" id="enrollCourseCode"class="form-control" placeholder="Enter course code to enroll">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" id="btnEnrollCourse" type="button">Enroll</button>
                                </div>
                            </div>
                            <table class="table table-bordered table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Course Name</th>
                                        <th>Course Code</th>
                                        <th>CRN</th>
                                        <th>Instructor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Intro to Web Dev</td>
                                        <td>CSCI101</td>
                                        <td>12345</td>
                                        <td>Dr. Smith</td>
                                    </tr>
                                    <tr>
                                        <td>Software Engineering</td>
                                        <td>CSCI202</td>
                                        <td>23456</td>
                                        <td>Prof. Lee</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Student Teams Tab -->
                        <div class="tab-pane fade" id="student-teams" role="tabpanel">
                            <h3>My Teams</h3>
                            <table class="table table-bordered table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Team Name</th>
                                        <th>Course</th>
                                        <th>Members</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Team Alpha</td>
                                        <td>CSCI101</td>
                                        <td>Alice, Bob, Carol</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Student Reviews Tab -->
                        <div class="tab-pane fade" id="student-reviews" role="tabpanel">
                            <h3>Reviews</h3>
                            <div class="card mb-4">
                                <div class="card-header bg-warning text-white">
                                    <h5 class="card-title mb-0">Pending Reviews</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        <a href="#" class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">Teamwork Feedback</h5>
                                                <small>Due: 2024-05-10</small>
                                            </div>
                                            <p class="mb-1">Please provide feedback on your team members' performance.</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge badge-info">Private</span>
                                                <button class="btn btn-primary btn-sm">Complete Review</button>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">Completed Reviews</h5>
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        <a href="#" class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">Project Reflection</h5>
                                                <small>Completed: 2024-04-20</small>
                                            </div>
                                            <p class="mb-1">Reflect on your project experience and team collaboration.</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge badge-success">Public</span>
                                                <button class="btn btn-secondary btn-sm">View Feedback</button>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Student Reports Tab -->
                        <div class="tab-pane fade" id="student-reports" role="tabpanel">
                            <h3>My Reports</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="card-title mb-0">Overall Performance</h5>
                                        </div>
                                        <div class="card-body">
                                            <h4 class="text-center mb-4">88%</h4>
                                            <div class="progress mb-3">
                                                <div class="progress-bar" role="progressbar" style="width: 88%"></div>
                                            </div>
                                            <p class="text-center">Your current average across all reviews</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="card-title mb-0">Recent Feedback</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="list-group">
                                                <div class="list-group-item">
                                                    <h6 class="mb-1">Team Collaboration</h6>
                                                    <p class="mb-1">"Excellent team player, always contributes valuable insights."</p>
                                                    <small>From: Team Alpha Review</small>
                                                </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teacher Dashboard -->
        <div id="teacherDashboardContent" class="page-content" style="display: none;">
            <div id="teacherDashboardPageContent">
                <div class="container py-4" style="padding-top: 5rem;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn-secondary" onclick="showLanding()">&larr; Back to Landing Page</button>
                        <h1 class="mb-0">Instructor Dashboard</h1>
                    </div>
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h1 class="mb-0">Instructor Dashboard</h1>
                            </div>
                            <ul class="nav nav-tabs" id="teacherTabs" role="tablist">
                                <li class="nav-item"><a class="nav-link active" id="teacher-overview-tab" data-toggle="tab" href="#teacher-overview" role="tab">Overview</a></li>
                                <li class="nav-item"><a class="nav-link" id="teacher-courses-tab" data-toggle="tab" href="#teacher-courses" role="tab">Courses</a></li>
                                <li class="nav-item"><a class="nav-link" id="teacher-teams-tab" data-toggle="tab" href="#teacher-teams" role="tab">Teams</a></li>
                                <li class="nav-item"><a class="nav-link" id="teacher-reviews-tab" data-toggle="tab" href="#teacher-reviews" role="tab">Reviews</a></li>
                                <li class="nav-item"><a class="nav-link" id="teacher-reports-tab" data-toggle="tab" href="#teacher-reports" role="tab">Reports</a></li>
                            </ul>
                            <div class="tab-content pt-3">
                                <!-- Teacher Overview Tab -->
                                <div class="tab-pane fade show active" id="teacher-overview" role="tabpanel">
                                    <h3>Welcome, <span id="teacherUserName">Instructor</span>!</h3>
                                    <p>This is your instructor dashboard. Use the tabs to manage your courses, teams, and reviews.</p>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">Active Courses <span class="badge badge-primary badge-pill" id="activeCoursesCount">0</span></li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">Total Students <span class="badge badge-success badge-pill" id="totalStudentsCount">0</span></li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">Pending Reviews <span class="badge badge-warning badge-pill" id="pendingReviewsCount">0</span></li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">Completed Reviews <span class="badge badge-info badge-pill" id="completedReviewsCount">0</span></li>
                                    </ul>
                                </div>
                                <!-- Teacher Courses Tab -->
                                <div class="tab-pane fade" id="teacher-courses" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h3>My Courses</h3>
                                        <button class="btn btn-primary" data-toggle="modal" data-target="#createCourseModal">Create Course</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="coursesTable">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Course Name</th>
                                                    <th>Course Number</th>
                                                    <th>Section</th>
                                                    <th>Term</th>
                                                    <th>Start Date</th>
                                                    <th>End Date</th>
                                                    <th>Course Code</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="coursesTableBody">
                                                <!-- Courses will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- Teacher Teams Tab -->
                                <div class="tab-pane fade" id="teacher-teams" role="tabpanel">
                                    <h3>Course Teams</h3>
                                    <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#createTeamModal">Create Team</button>
                                    <table class="table table-bordered table-hover">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Team Name</th>
                                                <th>Course</th>
                                                <th>Members</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teamsTableBody">
                                            <!-- Teams will be loaded here -->
                                        </tbody>
                                    </table>
                                    <!-- Create Team Modal -->
                                    <div class="modal fade" id="createTeamModal" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Create Team</h5>
                                                    <button type="button" class="close" data-dismiss="modal">
                                                        <span>&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="createTeamForm" onsubmit="return false">
                                                        <div class="form-group">
                                                            <label>Team Name</label>
                                                            <input type="text" id="teamName" class="form-control" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Course</label>
                                                            <select id="courseDropdown" class="form-control" required>
                                                                <!-- Will autofill -->
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Assign Students</label>
                                                            <select id="selectStudents" class="form-control" multiple>
                                                                <!-- Filled in later -->
                                                            </select>
                                                        </div>
                                                        <button type="button" class="btn btn-primary" id="createTeamBtn">Create Team</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Teacher Reviews Tab -->
                                <div class="tab-pane fade" id="teacher-reviews" role="tabpanel">
                                    <h3>Reviews</h3>
                                    <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#createReviewModal">Create Review</button>
                                    <div class="card mb-4">
                                        <div class="card-header bg-warning text-white">
                                            <h5 class="card-title mb-0">Pending Reviews</h5>
                                        </div>
                                        <div class="card-body">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Review Name</th>
                                                        <th>Course</th>
                                                        <th>Due Date</th>
                                                        <th>Visibility</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="pendingReviewsTableBody">
                                                    <tr>
                                                        <td>Teamwork Feedback</td>
                                                        <td>CSCI101</td>
                                                        <td>2024-05-10</td>
                                                        <td><span class="badge badge-info">Private</span></td>
                                                        <td><span class="badge badge-warning">Pending</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="card-title mb-0">Completed Reviews</h5>
                                        </div>
                                        <div class="card-body">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Review Name</th>
                                                        <th>Course</th>
                                                        <th>Completion Date</th>
                                                        <th>Visibility</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="completedReviewsTableBody">
                                                    <tr>
                                                        <td>Project Reflection</td>
                                                        <td>CSCI202</td>
                                                        <td>2024-04-20</td>
                                                        <td><span class="badge badge-success">Public</span></td>
                                                        <td><span class="badge badge-success">Completed</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <!-- Create Review Modal -->
                                    <div class="modal fade" id="createReviewModal" tabindex="-1" role="dialog">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Create Review</h5>
                                                    <button type="button" class="close" data-dismiss="modal">
                                                        <span>&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="createReviewForm" onsubmit="return false">
                                                        <div class="form-group">
                                                            <label>Review Name</label>
                                                            <input type="text" class="form-control" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Course</label>
                                                            <select id="reviewCourseDropdown" class="form-control" required>
                                                                <option>CSCI101 - Intro to Web Dev</option>
                                                                <option>CSCI202 - Software Engineering</option>
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Due Date</label>
                                                            <input type="date" class="form-control" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Visibility</label>
                                                            <select class="form-control" required>
                                                                <option value="public">Public</option>
                                                                <option value="private">Private</option>
                                                            </select>
                                                        </div>
                                                        <!-- Static Question fields removed -->
                                                        <div id="questionsContainer">
                                                            <!-- Dynamic questions will be added here -->
                                                        </div>
                                                        <button type="button" class="btn btn-secondary mb-3" onclick="addReviewQuestion()">Add Question</button>
                                                        <button type="button" class="btn btn-primary" id="createReviewSubmitBtn">Create Review</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Teacher Reports Tab -->
                                <div class="tab-pane fade" id="teacher-reports" role="tabpanel">
                                    <h3>Reports</h3>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <div class="card-header bg-primary text-white">
                                                    <h5 class="card-title mb-0">Student Averages</h5>
                                                </div>
                                                <div class="card-body">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Student</th>
                                                                <th>Average</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="studentAveragesTableBody">
                                                            <tr>
                                                                <td>Alice</td>
                                                                <td>92%</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Bob</td>
                                                                <td>88%</td>
                                                            </tr>
                                                            <tr>
                                                                <td>Carol</td>
                                                                <td>95%</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-info text-white">
                                                    <h5 class="card-title mb-0">Class Metrics</h5>
                                                </div>
                                                <div class="card-body">
                                                    <ul class="list-group">
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Average
                                                            <span class="badge badge-primary badge-pill">91.7%</span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Median
                                                            <span class="badge badge-primary badge-pill">92%</span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            Standard Deviation
                                                            <span class="badge badge-primary badge-pill">3.5</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" role="dialog" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <div class="card border-0">
                        <div class="card-body px-4 py-3">
                            <button type="button" class="close position-absolute" style="right: 1rem; top: 1rem;" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            
                            <!-- Login Form -->
                            <form id="frmLogin" onsubmit="return false">
                                <h1 class="text-center text-primary h2 mb-2">Welcome</h1>
                                <h3 class="text-center h4 mb-4">Sign In</h3>
                                <div class="form-group mb-3">
                                    <label for="txtEmail" class="mb-1">Email</label>
                                    <input type="email" id="txtEmail" class="form-control" placeholder="Enter your email">
                                </div>
                                <div class="form-group mb-4">
                                    <label for="txtPassword" class="mb-1">Password</label>
                                    <input type="password" id="txtPassword" class="form-control" placeholder="Enter your password">
                                </div>
                                <button id="btnLogin" type="button" class="btn btn-primary btn-lg col-12 mb-2">Sign In</button>
                                <button id="btnSwapRegister" type="button" class="btn btn-link col-12">New here? Create an account</button>
                            </form>

                            <!-- Registration Form -->
                            <form id="frmRegister" style="display:none;" onsubmit="return false">
                                <h1 class="text-center text-primary h2 mb-2">Welcome</h1>
                                <h3 class="text-center h4 mb-4">Create Your Account</h3>
                                <div class="form-group mb-3">
                                    <label for="txtFirstName" class="mb-1">First Name</label>
                                    <input type="text" id="txtFirstName" class="form-control" placeholder="Enter your first name">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="txtLastName" class="mb-1">Last Name</label>
                                    <input type="text" id="txtLastName" class="form-control" placeholder="Enter your last name">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="txtRegEmail" class="mb-1">Email</label>
                                    <input type="email" id="txtRegEmail" class="form-control" placeholder="Enter your .edu email">
                                    <small class="form-text text-muted">Please use your university email address</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="mb-1">Account Type</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="userType" id="studentType" value="student" checked>
                                        <label class="form-check-label" for="studentType">Student</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="userType" id="teacherType" value="teacher">
                                        <label class="form-check-label" for="teacherType">Teacher</label>
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="txtRegPassword" class="mb-1">Password</label>
                                    <input type="password" id="txtRegPassword" class="form-control" placeholder="Create a password">
                                </div>
                                <div class="form-group mb-4">
                                    <label for="txtConfirmPassword" class="mb-1">Confirm Password</label>
                                    <input type="password" id="txtConfirmPassword" class="form-control" placeholder="Confirm your password">
                                </div>
                                <button id="btnRegister" type="button" class="btn btn-primary btn-lg col-12 mb-2">Create Account</button>
                                <button id="btnSwapLogin" type="button" class="btn btn-link col-12">Already have an account? Sign in</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Course Modal -->
    <div class="modal fade" id="createCourseModal" tabindex="-1" role="dialog" aria-labelledby="createCourseModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createCourseModalLabel">Create New Course</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="createCourseForm" onsubmit="return false">
                        <div class="form-group">
                            <label for="courseName">Course Name</label>
                            <input type="text" class="form-control" id="courseName" required>
                        </div>
                        <div class="form-group">
                            <label for="courseNumber">Course Number</label>
                            <input type="text" class="form-control" id="courseNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="courseSection">Section</label>
                            <input type="text" class="form-control" id="courseSection" required>
                        </div>
                        <div class="form-group">
                            <label for="courseTerm">Term</label>
                            <select class="form-control" id="courseTerm" required>
                                <option value="Spring">Spring</option>
                                <option value="Summer">Summer</option>
                                <option value="Fall">Fall</option>
                                <option value="Winter">Winter</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createCourseBtn">Create Course</button>
                </div>
            </div>
        </div>
    </div>

    <!-- No jQuery - using vanilla JS instead -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Tab functionality in vanilla JS
        function setupTabs() {
            document.querySelectorAll('[data-toggle="tab"]').forEach(tabTrigger => {
                tabTrigger.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Find the target tab
                    const target = document.querySelector(this.getAttribute('href'));
                    if (!target) return;
                    
                    // Find parent tab list
                    const tabList = this.closest('.nav-tabs');
                    if (!tabList) return;
                    
                    // Hide all tabs in the same group
                    const tabContainer = target.closest('.tab-content');
                    if (tabContainer) {
                        const allTabs = tabContainer.querySelectorAll('.tab-pane');
                        allTabs.forEach(tab => {
                            tab.classList.remove('show', 'active');
                        });
                    }
                    
                    // Deactivate all tab triggers
                    const allTabTriggers = tabList.querySelectorAll('.nav-link');
                    allTabTriggers.forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Activate the clicked tab and its content
                    this.classList.add('active');
                    target.classList.add('show', 'active');
                });
            });
        }
        
        // Add a function to handle opening modals with data-toggle
        function setupModals() {
            const modalTriggers = document.querySelectorAll('[data-toggle="modal"]');
            modalTriggers.forEach(trigger => {
                trigger.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetModal = document.querySelector(this.getAttribute('data-target'));
                    if (targetModal) {
                        // Custom show modal function
                        showModal(targetModal.id);
                    }
                });
            });
            
            // Add click handlers for modal close buttons
            const closeButtons = document.querySelectorAll('[data-dismiss="modal"]');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal.id);
                });
            });
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            modal.style.display = 'block';
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
            document.body.classList.add('modal-open');
            
            // Trigger shown.bs.modal event
            const event = new CustomEvent('shown.bs.modal');
            modal.dispatchEvent(event);
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            modal.style.display = 'none';
            
            // Remove backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.parentNode.removeChild(backdrop);
            }
            document.body.classList.remove('modal-open');
            
            // Trigger hidden.bs.modal event
            const event = new CustomEvent('hidden.bs.modal');
            modal.dispatchEvent(event);
        }
        
        // Run setup when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupModals();
        });
    </script>
    <script>
        // API base URL
        const API_BASE_URL = 'http://localhost:3000/api';
    </script>
    <script>
        // Modal related functions for auth modal
        function showAuthModal(showRegister = false) {
            // Show the modal using the vanilla JS modal function
            showModal('authModal');
            
            if (showRegister) {
                document.getElementById('frmLogin').style.display = 'none';
                document.getElementById('frmRegister').style.display = 'block';
            } else {
                document.getElementById('frmLogin').style.display = 'block';
                document.getElementById('frmRegister').style.display = 'none';
            }
        }

        // Custom event setup for application-specific events
        function setupCustomEvents() {
            document.getElementById('authModal').addEventListener('shown.bs.modal', function () {
                // Keep the current page visible
                const currentPage = document.getElementById(`${AppState.currentPage}Content`);
                if (currentPage) {
                    currentPage.style.display = 'block';
                    currentPage.classList.add('active');
                }
            });

            document.getElementById('authModal').addEventListener('hidden.bs.modal', function () {
                // Show appropriate content when modal closes
                if (AppState.currentUser) {
                    showDashboard();
                } else {
                    showLanding();
                }
            });

            document.getElementById('createTeamModal').addEventListener('shown.bs.modal', function (event) {
                if (event) event.preventDefault();
                // Just use our preload function which doesn't fetch if data is already cached
                preloadTeamDropdown();
            });
            
            // Setup dropdown toggle functionality
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const dropdownMenu = this.nextElementSibling;
                    if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                        // Close other open dropdowns
                        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                            if (menu !== dropdownMenu) {
                                menu.classList.remove('show');
                            }
                        });
                        
                        // Toggle the current dropdown
                        dropdownMenu.classList.toggle('show');
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
        }

        // Update the DOM ready event to use all our custom code
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            setupModals();
            setupCustomEvents();
        });
    </script>

<!-- Add back the missing JavaScript application code -->
<script>
    // Add state management
    const AppState = {
        currentPage: 'landing',
        currentUser: null,
        currentSessionId: null,
        isLoading: false,
        cachedCourses: [],
        cachedStudents: {}, // Map of courseId -> students array
        cachedTeams: []     // Add cached teams array
    };

    // Global error handling functions
    function showError(message) {
        Swal.fire({
            title: 'Error',
            text: message,
            icon: 'error'
        });
    }

    function showSuccess(message) {
        Swal.fire({
            title: 'Success',
            text: message,
            icon: 'success'
        });
    }

    // Add loading overlay to prevent flickering
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loadingOverlay';
    loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 9999;
        display: none;
    `;
    document.body.appendChild(loadingOverlay);

    function showLoading() {
        loadingOverlay.style.display = 'block';
    }

    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Form elements
        const loginForm = document.getElementById('frmLogin');
        const registerForm = document.getElementById('frmRegister');
        const btnLogin = document.getElementById('btnLogin');
        const btnRegister = document.getElementById('btnRegister');
        const btnSwapRegister = document.getElementById('btnSwapRegister');
        const btnSwapLogin = document.getElementById('btnSwapLogin');
        const authModal = document.getElementById('authModal');

        // Input fields
        const txtEmail = document.getElementById('txtEmail');
        const txtPassword = document.getElementById('txtPassword');
        const txtRegEmail = document.getElementById('txtRegEmail');
        const txtRegPassword = document.getElementById('txtRegPassword');
        const txtConfirmPassword = document.getElementById('txtConfirmPassword');
        const txtFirstName = document.getElementById('txtFirstName');
        const txtLastName = document.getElementById('txtLastName');

        // Event Listeners
        btnLogin.addEventListener('click', handleLogin);
        btnRegister.addEventListener('click', handleRegister);
        btnSwapRegister.addEventListener('click', () => swapForms(loginForm, registerForm));
        btnSwapLogin.addEventListener('click', () => swapForms(registerForm, loginForm));

        // Add event listener for sign out button
        const signOutButton = document.getElementById('signOutButton');
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                signOut();
            });
        }
        
        // Also add a direct event listener on the Dashboard link
        const dashboardLink = document.getElementById('dashboardLink');
        if (dashboardLink) {
            dashboardLink.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showDashboard();
            });
        }

        // Functions
        async function handleLogin() {
            try {
                console.log('Attempting login with email:', txtEmail.value.trim());
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: txtEmail.value.trim(), 
                        password: txtPassword.value.trim() 
                    })
                });

                console.log('Login response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Login failed with error:', errorData);
                    throw new Error(errorData.error || 'Login failed');
                }

                const data = await response.json();
                console.log('Login successful, received data:', data);
                
                AppState.currentUser = data.user;
                AppState.currentSessionId = data.sessionId;
                
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                localStorage.setItem('sessionId', data.sessionId);
                
                closeModal('authModal');
                updateUIForLoggedInUser();
                showDashboard();
            } catch (error) {
                console.error('Login error details:', {
                    message: error.message,
                    stack: error.stack
                });
                showError(error.message);
            }
        }

        async function handleRegister() {
            showLoading();
            const email = txtRegEmail.value.trim();
            const password = txtRegPassword.value.trim();
            const confirmPassword = txtConfirmPassword.value.trim();
            const firstName = txtFirstName.value.trim();
            const lastName = txtLastName.value.trim();
            const userType = document.querySelector('input[name="userType"]:checked').value;

            if (!validateEmail(email)) {
                showError("Please enter a valid email address.");
                return;
            }
            if (!validateEduEmail(email)) {
                showError("Please use your university email address (.edu).");
                return;
            }
            if (password.length < 6) {
                showError("Your password needs to be at least 6 characters long.");
                return;
            }
            if (password !== confirmPassword) {
                showError("The passwords don't match. Please try again.");
                return;
            }
            if (firstName.length < 1 || lastName.length < 1) {
                showError("Please enter both your first and last name.");
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        firstName,
                        lastName,
                        userType
                    })
                });

                if (!response.ok) {
                    throw new Error('Registration failed');
                }

                const data = await response.json();
                AppState.currentUser = data.user;
                AppState.currentSessionId = data.sessionId;
                
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                localStorage.setItem('sessionId', data.sessionId);
                
                closeModal('authModal');
                updateUIForLoggedInUser();
                showDashboard();
            } catch (error) {
                hideLoading();
                showError(error.message);
            }
        }

        function swapForms(hideForm, showForm) {
            hideForm.style.display = 'none';
            showForm.style.display = 'block';
        }

        function validateEmail(email) {
            return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email);
        }

        function validateEduEmail(email) {
            return /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.edu$/.test(email);
        }
    });

    // Check for existing session and page state on load
    document.addEventListener('DOMContentLoaded', () => {
        // Hide all content initially
        const pages = document.querySelectorAll('.page-content');
        pages.forEach(page => {
            page.style.display = 'none';
            page.classList.remove('active');
        });

        // Check session and restore state
        const user = localStorage.getItem('currentUser');
        const sessionId = localStorage.getItem('sessionId');
        const currentPage = sessionStorage.getItem('currentPage');
        
        if (user && sessionId) {
            console.log('Found user and sessionId in localStorage:', user, sessionId);
            // Verify the session is still valid
            verifySession(sessionId)
                .then(valid => {
                    console.log('verifySession result:', valid);
                    if (valid) {
                        AppState.currentUser = JSON.parse(user);
                        AppState.currentSessionId = sessionId;
                        updateUIForLoggedInUser();
                        // Restore correct dashboard page
                        if (currentPage === 'teacherDashboard' || currentPage === 'studentDashboard') {
                            setPageState(currentPage);
                            if (currentPage === 'teacherDashboard') loadTeacherData();
                            if (currentPage === 'studentDashboard') loadStudentData();
                        } else {
                            showLanding();
                        }
                    } else {
                        // Session is invalid, clear it
                        handleSessionExpiration();
                    }
                })
                .catch(err => {
                    console.error('Error verifying session:', err);
                    handleSessionExpiration();
                });
        } else {
            console.log('No user/sessionId in localStorage');
            updateUIForLoggedOutUser();
            showLanding();
        }
    });

    // Verify session with the server
    async function verifySession(sessionId) {
        try {
            const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                method: 'GET',
                headers: {
                    'session-id': sessionId
                }
            });
            
            // If response is ok, session is valid
            return response.ok;
        } catch (error) {
            console.error('Session verification error:', error);
            return false;
        }
    }

    // Handle session expiration
    function handleSessionExpiration() {
        // Clear local state
        AppState.currentUser = null;
        AppState.currentSessionId = null;
        AppState.cachedCourses = [];
        AppState.cachedStudents = {};
        AppState.cachedTeams = [];
        localStorage.removeItem('currentUser');
        localStorage.removeItem('sessionId');
        
        // Update UI
        updateUIForLoggedOutUser();
        showLanding();
        
        // Show error message to user
        showError('Your session has expired. Please sign in again.');
    }

    function checkSession() {
        const user = localStorage.getItem('currentUser');
        const sessionId = localStorage.getItem('sessionId');
        
        if (user && sessionId) {
            // Verify session is still valid
            verifySession(sessionId)
                .then(valid => {
                    if (valid) {
                        AppState.currentUser = JSON.parse(user);
                        AppState.currentSessionId = sessionId;
                        updateUIForLoggedInUser();
                        
                        // Only show dashboard if we're not already on it
                        if (sessionStorage.getItem('currentPage') !== 'dashboard') {
                            showDashboard();
                        }
                    } else {
                        handleSessionExpiration();
                    }
                })
                .catch(err => {
                    console.error('Error checking session:', err);
                    handleSessionExpiration();
                });
        } else {
            updateUIForLoggedOutUser();
            showLanding();
        }
    }

    function showDashboard(event) {
        if (event) event.preventDefault();
        if (!AppState.currentUser) {
            setPageState('landing');
            return;
        }

        // Verify session before showing dashboard
        verifySession(AppState.currentSessionId)
            .then(valid => {
                if (!valid) {
                    handleSessionExpiration();
                    return;
                }
                // Set the appropriate page state based on user type
                if (AppState.currentUser.userType === 'teacher') {
                    setPageState('teacherDashboard');
                    sessionStorage.setItem('currentPage', 'teacherDashboard');
                    loadTeacherData();
                } else {
                    setPageState('studentDashboard');
                    sessionStorage.setItem('currentPage', 'studentDashboard');
                    loadStudentData();
                }
            })
            .catch(err => {
                console.error('Error verifying session for dashboard:', err);
                handleSessionExpiration();
            });
    }

    function showLanding(event) {
        if (event) event.preventDefault();
        setPageState('landing');
        sessionStorage.setItem('currentPage', 'landing');
    }

    // Add these functions to handle dashboard data loading
    async function loadStudentData() {
        try {
            const response = await fetch(`http://localhost:3000/api/enrollments/${AppState.currentUser.userId}`, {
                headers: {
                    'session-id': AppState.currentSessionId
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load student data');
            }
            
            const data = await response.json();
            
            // Update student dashboard with real data
            document.getElementById('studentUserName').textContent = AppState.currentUser.firstName;
            // Add more data updates here as needed
            const tableBody = document.querySelector('#student-courses tbody');
            tableBody.innerHTML = ''; // Clear old rows
            data.forEach(course => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.course_name}</td>
                    <td>${course.course_number}</td>
                    <td>${course.course_section}</td>
                    <td>${course.instructor || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Load student teams
            await loadStudentTeams();
            
        } catch (error) {
            console.error('Error loading student data:', error);
            showError('Failed to load student dashboard data');
        }
    }

    // Add function to load student teams
    async function loadStudentTeams() {
        try {
            const response = await fetch(`${API_BASE_URL}/teams/student`, {
                headers: {
                    'session-id': AppState.currentSessionId
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load student teams');
            }

            const teams = await response.json();
            const tableBody = document.querySelector('#student-teams tbody');
            tableBody.innerHTML = ''; // Clear old rows

            if (teams.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">You are not assigned to any teams yet.</td>
                    </tr>
                `;
                return;
            }

            teams.forEach(team => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${team.group_name}</td>
                    <td>${team.course_number} - ${team.course_name}</td>
                    <td>${team.members.join(', ')}</td>
                `;
                tableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading student teams:', error);
            showError('Failed to load student teams');
            const tableBody = document.querySelector('#student-teams tbody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-danger">Error loading teams. Please try again later.</td>
                </tr>
            `;
        }
    }

    async function loadTeacherData() {
        try {
            // First, fetch and cache courses
            const response = await fetch(`${API_BASE_URL}/courses`, {
                headers: {
                    'session-id': AppState.currentSessionId,
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                },
                credentials: 'same-origin',
                cache: 'no-store'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load teacher data');
            }
            
            const courses = await response.json();
            
            // Cache the courses data
            AppState.cachedCourses = courses;
            
            // Reset cached students
            AppState.cachedStudents = {};
            
            // If there are courses, prefetch students for ALL courses
            if (courses.length > 0) {
                console.log('Prefetching students for all courses');
                
                // Create an array of fetch promises to load students for all courses
                const fetchPromises = courses.map(course => {
                    return fetch(`${API_BASE_URL}/courses/${course.course_id}/students`, {
                        headers: {
                            'session-id': AppState.currentSessionId
                        }
                    })
                    .then(res => {
                        if (res.ok) return res.json();
                        return []; // Empty array if fetch fails
                    })
                    .then(students => {
                        AppState.cachedStudents[course.course_id] = students;
                        console.log(`Cached ${students.length} students for course ${course.course_id}`);
                    })
                    .catch(err => {
                        console.error(`Error fetching students for course ${course.course_id}:`, err);
                        AppState.cachedStudents[course.course_id] = []; // Set empty array
                    });
                });
                
                // Wait for all student data to be fetched
                try {
                    await Promise.all(fetchPromises);
                    console.log('All student data prefetched successfully');
                } catch (err) {
                    console.error('Error prefetching all student data:', err);
                    // Non-critical error, continue loading the dashboard
                }
            }
            
            // Fetch and cache teams data
            try {
                const teamsResponse = await fetch(`${API_BASE_URL}/teams`, {
                    headers: {
                        'session-id': AppState.currentSessionId
                    }
                });
                
                if (teamsResponse.ok) {
                    const teams = await teamsResponse.json();
                    AppState.cachedTeams = teams;
                    console.log(`Cached ${teams.length} teams`);
                    
                    // Display teams in the teams tab
                    displayTeams();
                } else {
                    console.error('Failed to fetch teams data');
                    AppState.cachedTeams = [];
                }
            } catch (error) {
                console.error('Error fetching teams data:', error);
                AppState.cachedTeams = [];
            }
            
            // Update teacher dashboard with real data
            document.getElementById('teacherUserName').textContent = AppState.currentUser.firstName;
            
            // Update courses table
            const coursesTableBody = document.getElementById('coursesTableBody');
            coursesTableBody.innerHTML = '';
            
            if (courses.length === 0) {
                coursesTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">No courses found. Create your first course!</td>
                    </tr>
                `;
            } else {
                courses.forEach(course => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${course.course_name}</td>
                        <td>${course.course_number}</td>
                        <td>${course.course_section}</td>
                        <td>${course.course_term}</td>
                        <td>${new Date(course.start_date).toLocaleDateString()}</td>
                        <td>${new Date(course.end_date).toLocaleDateString()}</td>
                        <td>${course.course_id}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course.course_id}')">Delete</button>
                        </td>
                    `;
                    coursesTableBody.appendChild(row);
                });
            }

            // Update overview counts
            document.getElementById('activeCoursesCount').textContent = courses.length;
            
            // TODO: Update other counts when we implement those features
            document.getElementById('totalStudentsCount').textContent = '0';
            document.getElementById('pendingReviewsCount').textContent = '0';
            document.getElementById('completedReviewsCount').textContent = '0';
            
            // Preload the courses dropdown for team creation
            preloadTeamDropdown();
            
            // Populate the review course dropdown
            populateReviewCourseDropdown();
            
            // Load teacher reviews
            loadTeacherReviews();

            // Load teacher student reports
            loadTeacherStudentReports();
            
        } catch (error) {
            console.error('Error loading teacher data:', error);
            showError('Failed to load teacher dashboard data');
        }
    }

    // Function to load and display student average reports for the teacher
    async function loadTeacherStudentReports() {
        const tableBody = document.getElementById('studentAveragesTableBody');
        if (!tableBody) {
            console.error('Student averages table body not found');
            return;
        }
        tableBody.innerHTML = '<tr><td colspan="2" class="text-center">Loading reports...</td></tr>'; // Loading indicator

        try {
            const response = await fetch(`${API_BASE_URL}/reports/teacher/students`, {
                headers: {
                    'session-id': AppState.currentSessionId
                }
            });

            // Check if the response is ok AND is JSON before parsing
            const contentType = response.headers.get("content-type");
            if (!response.ok) {
                let errorMsg = `HTTP error! status: ${response.status}`;
                // Try to get more specific error from text if not JSON
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const errorData = await response.json(); 
                    errorMsg = errorData.error || errorMsg;
                } else {
                    // If not JSON, maybe it's HTML or text
                    const textError = await response.text();
                    console.error("Non-JSON error response:", textError); // Log the raw response
                    errorMsg += " - Server sent non-JSON response."; 
                }
                throw new Error(errorMsg);
            } 
            // Only parse if content type is JSON
            else if (!contentType || contentType.indexOf("application/json") === -1) {
                 const textResponse = await response.text();
                 console.error("Received non-JSON response:", textResponse);
                 throw new Error("Received non-JSON response from server.");
            }
            
            // If response is ok and content type is JSON, parse it
            const reports = await response.json();

            tableBody.innerHTML = ''; // Clear loading/previous rows

            if (reports.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="2" class="text-center">No student data available for reports.</td></tr>';
                return;
            }

            reports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.firstName} ${report.lastName}</td>
                    <td>${report.average}</td>
                `;
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error('Error loading teacher student reports:', error);
            showError('Failed to load student reports');
            tableBody.innerHTML = `<tr><td colspan="2" class="text-center text-danger">Error loading reports: ${error.message}</td></tr>`;
        }
    }

    // Function to display teams in the teams tab
    function displayTeams() {
        const teamsTableBody = document.getElementById('teamsTableBody');
        if (!teamsTableBody) {
            console.error('Teams table body not found');
            return;
        }
        
        teamsTableBody.innerHTML = '';
        
        if (!AppState.cachedTeams || AppState.cachedTeams.length === 0) {
            teamsTableBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center">No teams found. Create your first team!</td>
                </tr>
            `;
            return;
        }
        
        AppState.cachedTeams.forEach(team => {
            const row = document.createElement('tr');
            
            // Format the members as a comma-separated list
            const membersText = Array.isArray(team.members) ? team.members.join(', ') : '';
            
            row.innerHTML = `
                <td>${team.group_name}</td>
                <td>${team.course_number} - ${team.course_name}</td>
                <td>${membersText}</td>
            `;
            
            teamsTableBody.appendChild(row);
        });
    }

    // Add this function to handle course deletion
    async function deleteCourse(courseId) {
        try {
            // Show confirmation dialog
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (!result.isConfirmed) {
                return;
            }

            // Store current scroll position
            const currentScroll = window.scrollY;

            const response = await fetch(`${API_BASE_URL}/courses/${courseId}`, {
                method: 'DELETE',
                headers: {
                    'session-id': AppState.currentSessionId
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete course');
            }

            showSuccess('Course deleted successfully');
            
            // Clear the course and student caches
            AppState.cachedCourses = [];
            AppState.cachedStudents = {};
            
            // Refresh the course list and restore scroll position
            await loadTeacherData();
            window.scrollTo(0, currentScroll);
        } catch (error) {
            showError(error.message);
        }
    }

    async function signOut() {
        try {
            const response = await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                headers: {
                    'session-id': AppState.currentSessionId
                }
            });

            if (!response.ok) {
                throw new Error('Logout failed');
            }

            // Clear local state
            AppState.currentUser = null;
            AppState.currentSessionId = null;
            AppState.cachedCourses = [];
            AppState.cachedStudents = {};
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionId');
            
            // Update UI without refreshing
            updateUIForLoggedOutUser();
            showLanding();
        } catch (error) {
            showError(error.message);
        }
    }

    function updateUIForLoggedInUser() {
        document.getElementById('authButtons').style.display = 'none';
        document.getElementById('userButtons').style.display = 'block';
        document.getElementById('userName').textContent = AppState.currentUser.firstName;
    }

    function updateUIForLoggedOutUser() {
        document.getElementById('authButtons').style.display = 'block';
        document.getElementById('userButtons').style.display = 'none';
        AppState.currentUser = null;
        AppState.currentSessionId = null;
    }

    // Add CSS for smooth transitions
    const style = document.createElement('style');
    style.textContent = `
        .page-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            margin-top: 4rem;
        }

        .page-content.active {
            opacity: 1;
            pointer-events: auto;
        }

        .navbar {
            z-index: 1000;
        }
        
        /* Dropdown styles */
        .dropdown-menu {
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
        }
    `;
    document.head.appendChild(style);

    // Update the navigation functions
    function setPageState(page) {
        // Update state
        AppState.currentPage = page;
        sessionStorage.setItem('currentPage', page);

        // Get all page elements
        const pages = document.querySelectorAll('.page-content');

        // Hide all pages first
        pages.forEach(page => {
            page.style.display = 'none';
            page.classList.remove('active');
        });

        // Show the target page
        const targetPage = document.getElementById(`${page}Content`);
        if (targetPage) {
            targetPage.style.display = 'block';
            targetPage.classList.add('active');
        }

        // Update navigation items
        const landingNavItems = document.querySelectorAll('#landingNavItems');
        landingNavItems.forEach(item => {
            item.style.display = page === 'landing' ? 'block' : 'none';
        });

        // Scroll to top
        window.scrollTo(0, 0);
    }

    // Add this function to handle smooth scrolling
    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            section.scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Add event listener for create course button
    document.getElementById('createCourseBtn').addEventListener('click', async function(event) {
        event.preventDefault();
        try {
            const courseData = {
                courseName: document.getElementById('courseName').value,
                courseNumber: document.getElementById('courseNumber').value,
                courseSection: document.getElementById('courseSection').value,
                courseTerm: document.getElementById('courseTerm').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value
            };

            const response = await fetch(`${API_BASE_URL}/courses`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'session-id': AppState.currentSessionId
                },
                body: JSON.stringify(courseData)
            });

            if (!response.ok) {
                const error = await response.json()
                throw new Error(error.error || 'Failed to create course');
            }

            const result = await response.json();

            // Clear the courses cache to ensure fresh data
            AppState.cachedCourses = [];
            AppState.cachedStudents = {};

            // Close modal and refresh courses
            closeModal('createCourseModal');
            showSuccess(`Course created successfully! Course Code: ${result.courseId}`);
            loadTeacherData();
        } catch (error) {
            showError(error.message);
        }
    });

    document.getElementById('btnEnrollCourse').addEventListener('click', async () => {
        const courseCode = document.getElementById('enrollCourseCode').value.trim()
        if (!courseCode) {
            showError('Please enter a course code');
            return;
        }

        try {
        const response = await fetch(`${API_BASE_URL}/enrollments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'session-id': AppState.currentSessionId
            },
            body: JSON.stringify({ courseId: courseCode })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Enrollment failed');

            showSuccess(`Successfully enrolled in course: ${result.courseName}`);
            
            const tableBody = document.querySelector('#student-courses tbody');
            const newRow = document.createElement('tr')
            newRow.innerHTML = `
                <td>${result.courseName}</td>
                <td>${result.courseNumber}</td>
                <td>${result.courseSection}</td>
                <td>${result.courseTerm}</td>
            `;
            tableBody.appendChild(newRow);

            document.getElementById('enrollCourseCode').value = '';

        } catch (err) {
        showError(err.message);
        }
    });

    document.getElementById('courseDropdown').addEventListener('change', (e) => {
        e.preventDefault(); // Explicitly prevent default
        e.stopPropagation(); // Stop event propagation
        
        console.log('Course dropdown changed, loading students from cache only');
        try {
            const courseId = e.target.value;
            
            // Use cached students only, preventing any fetch requests
            if (AppState.cachedStudents && AppState.cachedStudents[courseId]) {
                console.log(`Using cached students for selected course: ${courseId}`);
                populateStudentsDropdown(AppState.cachedStudents[courseId]);
            } else {
                console.warn('No cached students found for selected course - using empty array');
                populateStudentsDropdown([]);
            }
        } catch (error) {
            console.error('Error loading students:', error);
            showError('Failed to load students for course');
        }
        return false; // Extra precaution
    });

    async function loadStudentsForCourse(courseId) {
        // Check if we have cached students for this course
        if (AppState.cachedStudents[courseId]) {
            console.log(`Using cached students for course ${courseId}`);
            populateStudentsDropdown(AppState.cachedStudents[courseId]);
            return;
        }
        
        // If we get here, it means we don't have the student data cached
        console.log(`No cached students found for course ${courseId}`);
        
        // Instead of fetching and risking a page refresh, just show an empty list
        // This should only happen if there's an error in caching logic, as we should have prefetched all courses
        populateStudentsDropdown([]);
        console.warn('Student data should have been prefetched. Using empty list to prevent refresh.');
    }
    
    // Helper function to populate the students dropdown
    function populateStudentsDropdown(students) {
        const select = document.getElementById('selectStudents');
        if (!select) return;
        
        select.innerHTML = '';
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.user_id;
            option.textContent = `${student.first_name} ${student.last_name}`;
            select.appendChild(option);
        });
    }

    async function assignStudentsToGroup(groupId) {
        const selectedStudents = Array.from(document.getElementById('selectStudents').selectedOptions).map(o => o.value)
        if(selectedStudents.length === 0) return

        await fetch(`${API_BASE_URL}/teams/assign`, {
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json',
                'session-id': AppState.currentSessionId
            },
            body: JSON.stringify({ groupId, userIds: selectedStudents })
        })
    }

    async function preloadTeamDropdown() {
        console.log('Preloading team dropdown from cached data only');
        
        // Get dropdown element - it might not exist yet if modal hasn't been opened
        const select = document.getElementById('courseDropdown');
        if (!select) {
            console.log('Course dropdown not found - modal probably not opened yet');
            return; // Skip if not found
        }
        
        select.innerHTML = '';
        
        if (AppState.cachedCourses && AppState.cachedCourses.length > 0) {
            // Populate the courses dropdown
            AppState.cachedCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.course_number} - ${course.course_name}`;
                select.appendChild(option);
            });
            
            // Get first course ID
            const firstCourseId = AppState.cachedCourses[0].course_id;
            
            // Check if we have students for this course already cached
            if (AppState.cachedStudents && AppState.cachedStudents[firstCourseId]) {
                console.log(`Using cached students for first course: ${firstCourseId}`);
                // Populate the students dropdown using cached data
                populateStudentsDropdown(AppState.cachedStudents[firstCourseId]);
            } else {
                console.warn('No cached students found for first course - using empty array');
                populateStudentsDropdown([]);
            }
        } else {
            console.warn('No cached courses available to populate dropdown');
        }
    }

    async function loadCoursesForDropdown() {
        console.log('Loading courses for dropdown (using only cached data)');
        
        // Always use cached courses - should be available from dashboard load
        if (AppState.cachedCourses && AppState.cachedCourses.length > 0) {
            console.log('Using cached courses data for dropdown');
            preloadTeamDropdown();
            return false;
        } else {
            console.warn('No cached courses found. Dashboard should load this data.');
            showError('Course data not available. Please refresh the dashboard.');
            return false;
        }
    }

    document.getElementById('createTeamBtn').addEventListener('click', async function(event) {
        event.preventDefault();
        try {
            const teamName = document.getElementById('teamName').value.trim();
            const courseId = document.getElementById('courseDropdown').value;
            const studentIds = Array.from(document.getElementById('selectStudents').selectedOptions).map(opt => opt.value);

            if (!teamName || !courseId || studentIds.length === 0) {
                showError("Please fill out all fields and assign at least one student.");
                return;
            }

            const res = await fetch(`${API_BASE_URL}/teams`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'session-id': AppState.currentSessionId
                },
                body: JSON.stringify({
                    groupName: teamName,
                    courseId,
                    members: studentIds
                })
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || "Failed to create team");
            }

            showSuccess("Team created successfully!");
            closeModal('createTeamModal');
            document.getElementById('createTeamForm').reset();

            // Refresh teams data after creating a new team
            try {
                const teamsResponse = await fetch(`${API_BASE_URL}/teams`, {
                    headers: {
                        'session-id': AppState.currentSessionId
                    }
                });
                
                if (teamsResponse.ok) {
                    const teams = await teamsResponse.json();
                    AppState.cachedTeams = teams;
                    displayTeams();
                }
            } catch (error) {
                console.error('Error refreshing teams data:', error);
            }

        } catch (error) {
            console.error('Error:', error);
            showError(error.message || 'An error occurred');
        }
    });

    async function loadTeamsForTeacher() {
        const res = await fetch(`${API_BASE_URL}/teams`, {
            headers: {
                'session-id': AppState.currentSessionId
            }
        });

        const teams = await res.json();
        const tbody = document.querySelector('#teamsTableBody');
        tbody.innerHTML = '';

        teams.forEach(team => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${team.group_name}</td>
                <td>${team.course_number} - ${team.course_name}</td>
                <td>${team.members.join(', ')}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Add function to populate the course dropdown in the Create Review modal
    function populateReviewCourseDropdown() {
        const select = document.getElementById('reviewCourseDropdown');
        if (!select) {
            console.warn('Review course dropdown not found');
            return; 
        }
        
        select.innerHTML = ''; // Clear existing options
        
        if (AppState.cachedCourses && AppState.cachedCourses.length > 0) {
            console.log('Populating review course dropdown from cache');
            AppState.cachedCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.course_number} - ${course.course_name}`;
                select.appendChild(option);
            });
        } else {
            console.warn('No cached courses available for review dropdown');
            select.innerHTML = '<option value="">No courses found</option>'; // Placeholder
        }
    }

    // Add function to load and display teacher reviews
    async function loadTeacherReviews() {
        const pendingTableBody = document.getElementById('pendingReviewsTableBody');
        const completedTableBody = document.getElementById('completedReviewsTableBody');

        // Clear existing rows
        pendingTableBody.innerHTML = '';
        completedTableBody.innerHTML = '';

        try {
            const response = await fetch(`${API_BASE_URL}/assessments/teacher`, {
                headers: {
                    'session-id': AppState.currentSessionId
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load reviews');
            }

            const reviews = await response.json();

            if (reviews.length === 0) {
                pendingTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No pending reviews found.</td></tr>';
                completedTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No completed reviews found.</td></tr>';
                return;
            }

            const now = new Date();
            let pendingCount = 0;
            let completedCount = 0;

            reviews.forEach(review => {
                const row = document.createElement('tr');
                const courseDisplay = `${review.course_number} - ${review.course_name}`;
                const endDate = new Date(review.end_time);
                const isPending = review.status === 'pending' || review.status === 'open'; // Use status field
                
                // Use actual status and visibility from data
                const statusBadge = isPending ? '<span class="badge badge-warning">Pending/Open</span>' : '<span class="badge badge-success">Completed</span>';
                const visibilityBadge = review.visibility === 'public' 
                                         ? '<span class="badge badge-success">Public</span>' 
                                         : '<span class="badge badge-info">Private</span>';
                const dateDisplay = endDate.toLocaleDateString();

                row.innerHTML = `
                    <td>${review.review_name}</td>
                    <td>${courseDisplay}</td>
                    <td>${dateDisplay}</td>
                    <td>${visibilityBadge}</td> 
                    <td>${statusBadge}</td>
                `;

                if (isPending) {
                    pendingTableBody.appendChild(row);
                    pendingCount++;
                } else {
                    completedTableBody.appendChild(row);
                    completedCount++;
                }
            });

            // Update overview counts (simple update for now)
            document.getElementById('pendingReviewsCount').textContent = pendingCount;
            document.getElementById('completedReviewsCount').textContent = completedCount;

            if (pendingCount === 0) {
                pendingTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No pending reviews found.</td></tr>';
            }
            if (completedCount === 0) {
                completedTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No completed reviews found.</td></tr>';
            }

        } catch (error) {
            console.error('Error loading teacher reviews:', error);
            showError('Failed to load reviews');
            pendingTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading reviews.</td></tr>';
            completedTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading reviews.</td></tr>';
        }
    }

    // Function to add a new question row to the Create Review modal
    function addReviewQuestion() {
        const container = document.getElementById('questionsContainer');
        const questionIndex = container.children.length; // For unique IDs if needed

        const questionDiv = document.createElement('div');
        questionDiv.classList.add('form-group', 'border', 'p-3', 'mb-3');
        questionDiv.innerHTML = `
            <label><strong>Question ${questionIndex + 1}</strong></label>
             <button type="button" class="close" aria-label="Close" onclick="this.parentElement.remove()">
                <span aria-hidden="true">&times;</span>
            </button>
            <div class="form-group">
                <label>Question Type</label>
                <select class="form-control question-type" required>
                    <option value="likert">Likert Scale</option>
                    <option value="multiple_choice">Multiple Choice</option>
                    <option value="short_answer">Short Answer</option>
                </select>
            </div>
            <div class="form-group">
                <label>Question Text</label>
                <input type="text" class="form-control question-text" required>
            </div>
            <!-- Add options input if needed for MC/Likert later -->
        `;
        container.appendChild(questionDiv);
    }

    // Function to handle the submission of the Create Review form
    async function handleCreateReview() {
        const form = document.getElementById('createReviewForm');
        const reviewName = form.querySelector('input[type="text"]').value.trim(); // First text input assumed to be name
        const courseId = document.getElementById('reviewCourseDropdown').value;
        const dueDate = form.querySelector('input[type="date"]').value;
        const visibility = form.querySelector('select[required]:not(#reviewCourseDropdown)').value; // Second required select assumed visibility
        
        const questionsContainer = document.getElementById('questionsContainer');
        const questionElements = questionsContainer.querySelectorAll('.form-group.border');
        
        const questions = [];
        questionElements.forEach(qDiv => {
            const type = qDiv.querySelector('.question-type').value;
            const text = qDiv.querySelector('.question-text').value.trim();
            // Basic validation within the loop
            if (text) { // Only add if text is provided
                questions.push({ type, text, options: [] }); // Add options later if needed
            } 
        });

        // --- Form Validation ---
        if (!reviewName) return showError('Please enter a review name.');
        if (!courseId) return showError('Please select a course.');
        if (!dueDate) return showError('Please select a due date.');
        if (!visibility) return showError('Please select visibility.');
        if (questions.length === 0) return showError('Please add at least one valid question.');
        // --- End Validation ---

        const payload = {
            courseId: courseId,
            name: reviewName,
            type: 'review', // Set type explicitly
            startTime: new Date().toISOString(), // Use current time as start time
            endTime: new Date(dueDate).toISOString(), // Ensure ISO format for end time
            visibility: visibility,
            questions: questions
        };

        console.log('Submitting review payload:', payload);

        try {
            showLoading(); // Show loading indicator
            const response = await fetch(`${API_BASE_URL}/assessments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'session-id': AppState.currentSessionId
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                 console.error('Create review error response:', result);
                throw new Error(result.error || 'Failed to create review');
            }

            showSuccess('Review created successfully!');
            closeModal('createReviewModal');
            form.reset(); // Reset the form
            questionsContainer.innerHTML = ''; // Clear dynamic questions
            loadTeacherReviews(); // Refresh the reviews list

        } catch (error) {
            console.error('Error creating review:', error);
            showError(error.message);
        } finally {
            hideLoading(); // Hide loading indicator
        }
    }
    
    // Add event listener for the submit button
    document.addEventListener('DOMContentLoaded', () => {
        const submitBtn = document.getElementById('createReviewSubmitBtn');
        if(submitBtn) {
             submitBtn.addEventListener('click', handleCreateReview);
        }
       
        // Add at least one question by default when modal opens (optional)
        const createReviewModal = document.getElementById('createReviewModal');
        if (createReviewModal) {
            createReviewModal.addEventListener('shown.bs.modal', function () {
                 const container = document.getElementById('questionsContainer');
                 // Add one question if container is empty
                 if (container && container.children.length === 0) {
                     addReviewQuestion(); 
                 }
            });
            // Clear questions when modal is hidden
             createReviewModal.addEventListener('hidden.bs.modal', function () {
                 const container = document.getElementById('questionsContainer');
                 if(container) container.innerHTML = '';
                 document.getElementById('createReviewForm').reset();
            });
        }
    });
</script>

<script>
    // Add mobile menu toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        const navbarToggler = document.querySelector('.navbar-toggler');
        const navbarCollapse = document.querySelector('.navbar-collapse');

        if (navbarToggler && navbarCollapse) {
            navbarToggler.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                navbarCollapse.classList.toggle('show');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!navbarCollapse.contains(e.target) && !navbarToggler.contains(e.target)) {
                    navbarCollapse.classList.remove('show');
                }
            });

            // Close menu when clicking on a nav link
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navbarCollapse.classList.remove('show');
                });
            });
        }
    });
</script>
</body>
</html>
